<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
        // Verifica se a URL tem o c√≥digo de recupera√ß√£o (type=recovery)
        if (window.location.hash.includes('type=recovery') || window.location.search.includes('type=recovery')) {
            console.log("‚ö° Recupera√ß√£o detectada! Iniciando transporte...");
            
            // 1. Pega o "Hash" inteiro (tudo que vem depois de #, onde est√° o token)
            var tokenHash = window.location.hash;
            
            // 2. Se n√£o tiver hash, tenta pegar os par√¢metros de busca (?code=...)
            if (!tokenHash) tokenHash = window.location.search;

            // 3. Joga o usu√°rio para a p√°gina nova-senha.html LEVANDO O TOKEN JUNTO
            // Sem o tokenHash, a p√°gina nova-senha n√£o sabe quem √© o usu√°rio.
            window.location.href = 'nova-senha.html' + tokenHash;
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Est√©tica Premium">
    <meta name="theme-color" content="#D4AF37">
    
    <title>Est√©tica Premium - Gest√£o Profissional</title>
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icons/icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css?v=4.0">
    
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <i class="fas fa-spa loading-icon"></i>
            <h2>Est√©tica Premium</h2>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Sidebar Menu -->
    <nav id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-spa"></i>
            <h2>Est√©tica Premium</h2>
        </div>
        
        <ul class="sidebar-menu">
            <li class="menu-item active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </li>
            <li class="menu-item" data-page="clientes">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </li>
            <li class="menu-item" data-page="agenda">
                <i class="fas fa-calendar-alt"></i>
                <span>Agenda</span>
            </li>
            <li class="menu-item" data-page="servicos">
                <i class="fas fa-concierge-bell"></i>
                <span>Servi√ßos</span>
            </li>
            <li class="menu-item" data-page="estoque">
                <i class="fas fa-boxes"></i>
                <span>Estoque</span>
            </li>
            <li class="menu-item" data-page="relatorios">
                <i class="fas fa-chart-pie"></i>
                <span>Relat√≥rios</span>
            </li>
            <li class="menu-item" data-page="automacoes" onclick="carregarAutomacoes()">
                <i class="fas fa-robot"></i>
                <span>Automa√ß√µes</span>
            </li>
            <li class="menu-item" data-page="perfil" onclick="carregarDadosPerfil()">
                <i class="fas fa-user-circle"></i>
                <span>Meu Perfil</span>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <button 
                onclick="fazerLogout(event)" 
                ontouchstart="fazerLogout(event)" 
                class="btn-logout" 
                style="width: 100%; background: transparent; border: 1px solid #444; color: #fff; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 6px; font-size: 16px;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="main-content">
        <!-- Header -->
        <header class="app-header">
            <button id="menuToggle" class="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="pageTitle">Dashboard</h1>
            <div class="header-actions">
                <div class="notifications-wrapper" style="position: relative;">
                    <button class="icon-btn" id="notificationsBtn" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notifCount" style="display: none;">0</span>
                    </button>
                    
                    <div id="notificationsDropdown" class="notifications-dropdown">
                        <div class="notif-header">
                            <span>Alertas</span>
                            <button class="btn-link-gold" onclick="limparNotificacoes(event)">Limpar</button>
                        </div>
                        <div id="notifList" class="notif-list">
                            <div class="notif-empty">Tudo tranquilo por aqui! ‚ú®</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Container -->
        <div id="pageContainer" class="page-container">
    
            <div id="dashboardPage" class="page active">
    
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon gold">
                            <i class="far fa-calendar-check"></i>
                        </div>
                        <div class="metric-info">
                            <h3 id="statAgendamentosHoje">0</h3>
                            <p>AGENDAMENTOS HOJE</p>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="metric-info">
                            <h3 id="statFaturamentoHoje">R$ 0,00</h3>
                            <p>FATURAMENTO HOJE</p>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-info">
                            <h3 id="statTotalClientes">0</h3>
                            <p>TOTAL DE CLIENTES</p>
                        </div>
                    </div>

                    <div class="metric-card" style="border-left: 4px solid var(--error);">
                        <div class="metric-icon red">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="metric-info">
                            <h3 id="statDebitosTotal" style="color: var(--error);">R$ 0,00</h3>
                            <p>A RECEBER (GERAL)</p>
                        </div>
                    </div>

                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card full-width">
                        <div class="card-header">
                            <h3><i class="far fa-clock" style="color: var(--gold);"></i> Pr√≥ximos Agendamentos</h3>
                            <button class="btn-link-gold" onclick="navigateTo('agenda')">Ver Agenda</button>
                        </div>
                        <div id="dashAgendamentosList" class="dashboard-list">
                            <div style="padding: 20px; text-align: center; color: #666;">Carregando...</div>
                        </div>
                    </div>

                    <div class="dashboard-row-split">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-boxes" style="color: var(--warning);"></i> Alertas de Estoque</h3>
                            </div>
                            <div id="dashEstoqueList" class="dashboard-list"></div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-invoice-dollar" style="color: var(--error);"></i> Contas a Receber</h3>
                            </div>
                            <div id="dashContasReceberList" class="dashboard-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientesPage" class="page">
                <div class="header-controls">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchClientes" placeholder="Buscar clientes...">
                    </div>
                    <button class="btn-primary" onclick="abrirModalCliente()">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>
                <div id="clientesGrid" class="clientes-grid"></div>
            </div>

            <div id="agendaPage" class="page">
                <div class="page-header-custom">
                    <button onclick="abrirModalHorarios()" class="btn-secondary" style="border: 1px solid #444;">
                        <i class="fas fa-cog"></i> Hor√°rios
                    </button>
                    <h2 style="color: var(--gold); margin: 0;"><i class="far fa-calendar-alt"></i> Agenda</h2>
                    
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="copiarLinkAgendamento()" class="btn-share-link" title="Copiar Link para Cliente">
                            <i class="fas fa-share-alt"></i> <span class="texto-botao">Link</span>
                        </button>

                        <button id="btnConnectGoogle" onclick="conectarGoogle()" class="btn-google-sync" title="Conectar Agenda">
                            <i class="fab fa-google"></i> <span class="texto-botao">Conectar</span>
                        </button>

                        <button onclick="sincronizarPendentesGoogle()" class="btn-secondary" style="padding: 10px 15px; border: 1px solid #D4AF37; color: #D4AF37;" title="Enviar agendamentos do site para o Google">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="modern-calendar-wrapper">
                    <div class="calendar-header">
                        <button class="cal-btn" onclick="mudarMes(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <h3 id="calendarMonthYear">CARREGANDO...</h3>
                        
                        <button class="cal-btn" onclick="mudarMes(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-weekdays">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
                    </div>
                    
                    <div id="calendarGrid" class="calendar-grid"></div>
                    
                    <div class="calendar-footer">
                        <button class="btn-today-modern" onclick="hoje()">Ir para Hoje</button>
                    </div>
                </div>

                <div class="agenda-quick-actions" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 0 5px;">
                    <div style="font-size: 1.1rem;">
                        <span style="color: #888;">Data selecionada:</span>
                        <strong id="dataSelecionadaTexto" style="color: var(--gold); margin-left: 5px;">-</strong>
                    </div>
                    <button class="btn-primary" onclick="abrirModalAgendamento()">
                        <i class="fas fa-plus"></i> Novo Agendamento
                    </button>
                </div>

                <div id="agendaContainer" class="agenda-timeline"></div>
            </div>

            <div id="servicosPage" class="page">
                <div class="header-controls">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchServicos" placeholder="Buscar servi√ßos...">
                    </div>
                    <button class="btn-primary" onclick="abrirModalServico()">
                        <i class="fas fa-plus"></i> Novo Servi√ßo
                    </button>
                </div>
                <div id="servicosGrid" class="servicos-grid"></div>
            </div>

            <div id="estoquePage" class="page">
                <div class="header-controls">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchEstoque" placeholder="Buscar produtos...">
                    </div>
                    <button class="btn-primary" onclick="abrirModalEstoque()">
                        <i class="fas fa-plus"></i> Novo Produto
                    </button>
                </div>
                <div id="estoqueGrid" class="estoque-grid"></div>
            </div>

            <div id="relatoriosPage" class="page">
                <div class="page-header">
                    <div class="relatorio-date-picker">
                        <label>Per√≠odo:</label>
                        <select id="relatorioMes" onchange="carregarRelatorios()">
                            <option value="0">Janeiro</option>
                            <option value="1">Fevereiro</option>
                            <option value="2">Mar√ßo</option>
                            <option value="3">Abril</option>
                            <option value="4">Maio</option>
                            <option value="5">Junho</option>
                            <option value="6">Julho</option>
                            <option value="7">Agosto</option>
                            <option value="8">Setembro</option>
                            <option value="9">Outubro</option>
                            <option value="10">Novembro</option>
                            <option value="11">Dezembro</option>
                        </select>
                        <input type="number" id="relatorioAno" value="2026" onchange="carregarRelatorios()">
                    </div>
                    <button class="btn-primary" onclick="window.print()">
                        <i class="fas fa-file-pdf"></i> Imprimir
                    </button>
                </div>
                <div id="relatoriosContent" class="relatorios-grid">
                    </div>
            </div>
            <div id="perfilPage" class="page">
                <div class="page-header-custom">
                    <h2 style="color: var(--gold); margin: 0;"><i class="fas fa-user-cog"></i> Meu Perfil</h2>
                </div>

                <div class="profile-container-premium">
                    <div class="profile-header-card">
                        <div class="profile-avatar-wrapper">
                            <img id="avatarPreview" src="" alt="Foto de Perfil" style="display: none;">
                            
                            <div id="avatarDefaultIcon" class="avatar-default">
                                <i class="fas fa-user"></i>
                            </div>

                            <label for="inputFotoPerfil" class="avatar-overlay">
                                <i class="fas fa-camera"></i>
                                <span>Alterar</span>
                            </label>
                            
                            <input type="file" id="inputFotoPerfil" accept="image/*" onchange="uploadFotoPerfil(event)">
                        </div>
                        <div class="profile-title">
                            <h3 id="displayNome">Doutora</h3>
                            <span id="displayEmail">Carregando email...</span>
                        </div>
                    </div>

                    <form id="formPerfilInterno" onsubmit="salvarPerfilReal(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome Completo (Vis√≠vel para o cliente)</label>
                                <input type="text" id="profNome" placeholder="Ex: Dra. Ana Silva">
                            </div>
                            <div class="form-group">
                                <label>Especialidade</label>
                                <input type="text" id="profEspecialidade" placeholder="Ex: Biom√©dica Esteta">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Telefone / WhatsApp Profissional</label>
                                <input type="text" id="profTelefone" placeholder="(00) 00000-0000">
                            </div>
                            <div class="form-group">
                                <label>Link de Agendamento Personalizado</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="profLink" readonly style="background: #222; color: #888; font-size: 12px;">
                                    <button type="button" class="btn-secondary" onclick="copiarLinkPerfil()" style="width: auto; padding: 0 15px;">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                            <button type="submit" class="btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                                Salvar Altera√ß√µes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="automacoesPage" class="page">
                <div class="page-header-custom">
                    <h2 style="color: var(--gold); margin: 0;"><i class="fas fa-robot"></i> Automa√ß√µes e Mensagens</h2>
                </div>

                <div class="profile-container-premium">
                    <div class="form-card" style="padding: 25px; background: #1E1E1E; border-radius: 12px; border: 1px solid #333;">
                        <h3 style="margin-top: 0; color: #fff; display: flex; align-items: center; gap: 10px;">
                            <i class="fab fa-whatsapp" style="color: #25D366; font-size: 1.5rem;"></i> Confirma√ß√£o de Agendamento
                        </h3>
                        <p style="color: #888; font-size: 0.95rem; margin-bottom: 15px;">
                            Personalize a mensagem que ser√° enviada ao cliente. Clique nos bot√µes abaixo para copiar as vari√°veis (elas ser√£o trocadas automaticamente pelo sistema):
                        </p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="inserirVariavel('{nome}')">{nome}</button>
                            <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="inserirVariavel('{data}')">{data}</button>
                            <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="inserirVariavel('{hora}')">{hora}</button>
                            <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="inserirVariavel('{servico}')">{servico}</button>
                        </div>

                        <textarea id="textoAutomacaoZap" rows="7" style="width: 100%; background: #111; color: #fff; border: 1px solid #444; border-radius: 8px; padding: 15px; font-family: inherit; font-size: 1rem; resize: vertical;"></textarea>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="btn-primary" onclick="salvarAutomacoes(this)">
                                <i class="fas fa-save"></i> Salvar Mensagem
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-card" style="padding: 25px; background: #1E1E1E; border-radius: 12px; border: 1px solid #333; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #fff; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-envelope" style="color: #2196F3; font-size: 1.5rem;"></i> E-mail Autom√°tico
                            </h3>
                            <label class="switch">
                                <input type="checkbox" id="emailAtivoToggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        
                        <p style="color: #888; font-size: 0.95rem; margin-bottom: 15px;">
                            Configure o e-mail de confirma√ß√£o. As vari√°veis {nome}, {data}, {hora} e {servico} tamb√©m funcionam aqui!
                        </p>

                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="color: var(--gold);">Assunto do E-mail</label>
                            <input type="text" id="textoAssuntoEmail" style="width: 100%; background: #111; color: #fff; border: 1px solid #444; border-radius: 8px; padding: 10px;" placeholder="Ex: Confirma√ß√£o de Agendamento - Est√©tica Premium">
                        </div>

                        <div class="form-group">
                            <label style="color: var(--gold);">Corpo da Mensagem</label>
                            <textarea id="textoCorpoEmail" rows="7" style="width: 100%; background: #111; color: #fff; border: 1px solid #444; border-radius: 8px; padding: 15px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="btn-primary" onclick="salvarAutomacoesEmail(this)">
                                <i class="fas fa-save"></i> Salvar E-mail
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="modalAgendamento" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalAgendamentoTitle">Novo Agendamento</h2>
                    <button class="modal-close" onclick="fecharModal('modalAgendamento')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="formAgendamento" class="modal-form">
                    <input type="hidden" id="agendamentoId">
                    
                    <label style="margin-bottom: 10px; display: block;">O QUE VOC√ä VAI AGENDAR?</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="tipoAgendamento" value="servico" checked onclick="toggleTipoAgendamento()">
                            <span><i class="fas fa-cut"></i> Servi√ßo</span>
                        </label>

                        <label class="radio-label">
                            <input type="radio" name="tipoAgendamento" value="evento" onclick="toggleTipoAgendamento()">
                            <span><i class="fas fa-calendar-star"></i> Evento Pessoal</span>
                        </label>
                    </div>
                    
                    <div id="camposServico">
                        <div class="form-group" style="position: relative;">
                            <label>Cliente *</label>
                            <input type="text" id="inputBuscaCliente" placeholder="üîç Digite para buscar cliente..." oninput="filtrarClientesDropdown()" onfocus="abrirDropdownCliente()" style="width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 1rem;" autocomplete="off">
                            <input type="hidden" id="agendamentoCliente">
                            
                            <div id="dropdownClientes" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: #2A2A2A; border: 1px solid #D4AF37; border-radius: 6px; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                                </div>
                        </div>
                        
                        <div class="form-group" style="position: relative;">
                            <label>Servi√ßo *</label>
                            <input type="text" id="inputBuscaServico" placeholder="üîç Digite para buscar servi√ßo..." oninput="filtrarServicosDropdown()" onfocus="abrirDropdownServico()" style="width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 1rem;" autocomplete="off">
                            <input type="hidden" id="agendamentoServico">
                            
                            <div id="dropdownServicos" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: #2A2A2A; border: 1px solid #D4AF37; border-radius: 6px; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                                </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor (R$)</label>
                                <input type="text" id="agendamentoValor" readonly style="background: #222; color: var(--gold); font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>Status Pagamento</label>
                                <select id="agendamentoStatusPagamento">
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="devendo">Devendo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="camposEvento" style="display: none;">
                        <div class="form-group">
                            <label>Nome do Evento *</label>
                            <input type="text" id="eventoNome" placeholder="Ex: Almo√ßo, Reuni√£o...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data *</label>
                            <input type="date" id="agendamentoData" required>
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <input type="time" id="agendamentoHora" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="agendamentoObservacoes" rows="2"></textarea>
                    </div>
                    
                    <div class="modal-buttons" style="justify-content: space-between; align-items: center; display: flex; width: 100%;">
    
                        <button type="button" id="btnExcluirAgendaModal" class="btn-danger" style="display: none;" onclick="excluirDoModal()">
                            <i class="fas fa-trash"></i> Excluir
                        </button>

                        <div style="display: flex; gap: 10px; margin-left: auto;">
                            <button type="button" class="btn-secondary" onclick="fecharModal('modalAgendamento')">Cancelar</button>
                            <button type="submit" class="btn-primary">Salvar</button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Modal Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalClienteTitle">Novo Cliente</h2>
                <button class="modal-close" onclick="fecharModal('modalCliente')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="formCliente">
                <input type="hidden" id="clienteId">
                
                <div style="margin-bottom: 15px;">
                    <label>Nome Completo</label>
                    <input type="text" id="clienteNome" required placeholder="Ex: Maria Silva">
                </div>

                <div class="form-grid">
                    <div>
                        <label>Telefone</label>
                        <input type="tel" id="clienteTelefone" required placeholder="(11) 99999-9999">
                    </div>
                    <div>
                        <label>Data de Nascimento</label>
                        <input type="date" id="clienteNascimento">
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label>CPF</label>
                        <input type="text" id="clienteCpf" placeholder="000.000.000-00">
                    </div>
                    <div>
                        <label>Email</label>
                        <input type="email" id="clienteEmail" placeholder="email@exemplo.com">
                    </div>
                </div>

                <div style="margin: 20px 0; display: flex; align-items: center; gap: 10px;">
                    <hr style="flex: 1;">
                    <span style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gold);">Endere√ßo</span>
                    <hr style="flex: 1;">
                </div>

                <div class="grid-cep">
                    <div>
                        <label>CEP</label>
                        <input type="text" id="clienteCep" placeholder="00000-000" onblur="buscarCep()" maxlength="9">
                    </div>
                    <div>
                        <label>Rua / Logradouro</label>
                        <input type="text" id="clienteEndereco">
                    </div>
                </div>

                <div class="grid-numero">
                    <div>
                        <label>N√∫mero</label>
                        <input type="text" id="clienteNumero">
                    </div>
                    <div>
                        <label>Bairro</label>
                        <input type="text" id="clienteBairro">
                    </div>
                </div>

                <div class="grid-cidade">
                    <div>
                        <label>Cidade</label>
                        <input type="text" id="clienteCidade">
                    </div>
                    <div>
                        <label>UF</label>
                        <input type="text" id="clienteEstado" maxlength="2" style="text-transform: uppercase;">
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="fecharModal('modalCliente')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalDetalhesCliente" class="modal">
        <div class="modal-content">
            
            <div class="modal-header" style="border:none; padding-bottom: 0;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="cliente-avatar-large" id="detalhesAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h2 id="detalhesClienteNome" style="margin: 0; font-size: 1.8rem;">Nome do Cliente</h2>
                        <span class="status-badge" style="background: var(--bg-input); color: var(--text-secondary); margin-top: 5px; display: inline-block;">Cliente Cadastrado</span>
                    </div>
                </div>
                <div class="modal-footer-actions">
                    <button onclick="abrirAnamnese()" class="btn-action" style="border: 1px solid var(--gold); color: var(--gold); background: transparent;">
                        <i class="fas fa-file-medical"></i> Ficha Anamnese
                    </button>
                </div>
                <button class="modal-close" onclick="fecharModal('modalDetalhesCliente')">&times;</button>
            </div>

            <div class="modal-body" style="padding-top: 20px;">
                
                <div class="info-grid-row">
                    <div class="info-box">
                        <label>Telefone (WhatsApp)</label>
                        <span id="detalhesClienteTelefone">...</span>
                    </div>
                    <div class="info-box">
                        <label>E-mail</label>
                        <span id="detalhesClienteEmail">...</span>
                    </div>
                </div>
                
                <div class="info-box full-width" id="boxEndereco" style="margin-top: 15px;">
                    <label>Endere√ßo</label>
                    <span id="detalhesClienteEndereco">...</span>
                </div>

                <hr>

                <div class="client-stats-row">
                    <div class="stat-box">
                        <small>Total de Servi√ßos</small>
                        <strong id="detalhesTotalServicos">0</strong>
                    </div>
                    <div class="stat-box">
                        <small>Valor Gasto</small>
                        <strong id="detalhesValorTotal" style="color: var(--success);">R$ 0,00</strong>
                    </div>
                    <div class="stat-box">
                        <small>D√©bitos Pendentes</small>
                        <strong id="detalhesDebitos" style="color: var(--error);">R$ 0,00</strong>
                    </div>
                </div>

                <div class="detalhes-tabs" style="margin-top: 20px;">
                    <button class="tab-btn active" onclick="trocarTab('historico')">Hist√≥rico</button>
                    <button class="tab-btn" onclick="trocarTab('agendados')">Agendados</button>
                </div>

                <div id="tabHistorico" class="tab-content active">
                    <div id="detalhesHistorico" class="scroll-list"></div>
                </div>
                <div id="tabAgendados" class="tab-content">
                    <div id="detalhesAgendados" class="scroll-list"></div>
                </div>

                <div class="modal-footer-actions">
                    <button onclick="editarCliente()" class="btn-action edit">
                        <i class="fas fa-edit"></i> Editar Dados
                    </button>
                    <button onclick="deletarClienteAtual()" class="btn-action delete">
                        <i class="fas fa-trash"></i> Excluir Cliente
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div id="modalAnamnese" class="modal">
        <div class="modal-content anamnese-paper">
            <div class="modal-header no-print">
                <h2>Ficha de Anamnese</h2>
                <button class="modal-close" onclick="fecharModal('modalAnamnese')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="anamnese-header-print only-print">
                <h1>Est√©tica Premium</h1>
                <p>Ficha de Avalia√ß√£o e Anamnese</p>
            </div>

            <div class="anamnese-tabs no-print">
                <button type="button" class="tab-btn active" onclick="trocarTabAnamnese('texto')">
                    <i class="fas fa-list-alt"></i> Perguntas
                </button>
                <button type="button" class="tab-btn" onclick="trocarTabAnamnese('desenho')">
                    <i class="fas fa-pen-fancy"></i> Mapa Facial / Desenho
                </button>
            </div>

            <form id="formAnamnese">
                
                <div id="tabAnamneseTexto" class="anamnese-tab-content active">
                    <div class="anamnese-section">
                        <h3>1. Hist√≥rico de Sa√∫de</h3>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="saude_gestante"> Gestante / Lactante</label>
                            <label><input type="checkbox" name="saude_cardiaco"> Problemas Card√≠acos</label>
                            <label><input type="checkbox" name="saude_diabetes"> Diabetes</label>
                            <label><input type="checkbox" name="saude_alergia"> Alergias</label>
                            <label><input type="checkbox" name="saude_oncologico"> Hist√≥rico Oncol√≥gico</label>
                        </div>
                        <div class="form-group">
                            <label>Uso de Medicamentos Cont√≠nuos?</label>
                            <input type="text" name="medicamentos" placeholder="Quais?">
                        </div>
                        <div class="form-group">
                            <label>Alergias Espec√≠ficas?</label>
                            <input type="text" name="alergias_obs" placeholder="Medicamentos, cosm√©ticos, alimentos...">
                        </div>
                    </div>

                    <div class="anamnese-section">
                        <h3>2. Hist√≥rico Est√©tico</h3>
                        <div class="form-group">
                            <label>Queixa Principal</label>
                            <textarea name="queixa_principal" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Cuidados Di√°rios (Home Care)</label>
                            <input type="text" name="home_care">
                        </div>
                    </div>
                </div>

                <div id="tabAnamneseDesenho" class="anamnese-tab-content">
                    <div class="drawing-toolbar no-print">
                        <label>Cor da Caneta:</label>
                        <div class="color-picker">
                            <div class="color-dot active" style="background: #000;" onclick="setCorCaneta('#000000', this)"></div> <div class="color-dot" style="background: #E53935;" onclick="setCorCaneta('#E53935', this)"></div> <div class="color-dot" style="background: #1E88E5;" onclick="setCorCaneta('#1E88E5', this)"></div> <div class="color-dot" style="background: #43A047;" onclick="setCorCaneta('#43A047', this)"></div> </div>
                        <button type="button" class="btn-small" onclick="limparMapaFacial()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>

                    <div class="mapa-container">
                        <canvas id="mapaFacialCanvas" width="600" height="500"></canvas>
                        
                        <div class="mapa-background">
                            <svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg" stroke="#ccc" fill="none" stroke-width="1">
                                <path d="M50,60 C50,10 150,10 150,60 C150,130 130,160 100,170 C70,160 50,130 50,60 Z" />
                                <path d="M70,75 Q80,65 90,75" />
                                <path d="M110,75 Q120,65 130,75" />
                                <path d="M100,80 L95,110 L105,110" />
                                <path d="M85,130 Q100,140 115,130" />
                                <path d="M70,155 L70,200" />
                                <path d="M130,155 L130,200" />
                            </svg>
                        </div>
                    </div>
                    <p style="text-align: center; color: #888; font-size: 0.8rem;">Use a caneta do tablet para marcar √°reas de interesse.</p>
                </div>

                <div class="anamnese-section">
                    <h3>3. Termo e Assinatura</h3>
                    <p class="legal-text">
                        Declaro que as informa√ß√µes s√£o verdadeiras.
                    </p>
                    
                    <div class="signature-area">
                        <label>Assinatura da Cliente:</label>
                        
                        <div class="canvas-wrapper">
                            <canvas id="signatureCanvas"></canvas>
                        </div>
                        
                        <div class="signature-actions no-print">
                            <button type="button" class="btn-link-gold" onclick="limparAssinatura()">Limpar Assinatura</button>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons no-print">
                    <button type="button" class="btn-secondary" onclick="buscarEImprimirFicha()">
                        <i class="fas fa-print"></i> Imprimir Ficha Salva
                    </button>
                    
                    <button type="submit" class="btn-primary">Salvar Ficha</button>
                </div>
            </form>
        </div>
    </div>

    <div id="fichaImpressao" class="print-only-container">
        <div class="print-header">
            <h1>Est√©tica Premium</h1>
            <p>Ficha de Avalia√ß√£o e Anamnese</p>
            <div class="print-meta">
                <span><strong>Cliente:</strong> <span id="printNomeCliente"></span></span>
                <span><strong>Data:</strong> <span id="printDataFicha"></span></span>
            </div>
        </div>

        <div class="print-body">
            <div class="print-section">
                <h3>1. Hist√≥rico de Sa√∫de</h3>
                <div class="print-grid">
                    <div><span id="checkGestante">‚òê</span> Gestante/Lactante</div>
                    <div><span id="checkCardiaco">‚òê</span> Card√≠aco</div>
                    <div><span id="checkDiabetes">‚òê</span> Diabetes</div>
                    <div><span id="checkAlergia">‚òê</span> Alergias</div>
                    <div><span id="checkOnco">‚òê</span> Hist√≥rico Oncol√≥gico</div>
                </div>
                <p><strong>Medicamentos:</strong> <span id="printMedicamentos"></span></p>
                <p><strong>Alergias/Obs:</strong> <span id="printAlergias"></span></p>
            </div>

            <div class="print-section">
                <h3>2. Hist√≥rico Est√©tico</h3>
                <p><strong>Queixa Principal:</strong> <br> <span id="printQueixa"></span></p>
                <p><strong>Home Care:</strong> <span id="printHomeCare"></span></p>
            </div>

            <div class="print-section keep-together">
                <h3>3. Mapeamento Facial</h3>
                <div class="print-map-container">
                    <img id="printMapaImg" src="" alt="Mapa Facial" style="max-height: 300px; max-width: 100%; display: block; margin: 0 auto;">
                </div>
            </div>

            <div class="print-section keep-together">
                <h3>4. Termo de Responsabilidade</h3>
                <p class="legal-text-small">
                    Declaro que as informa√ß√µes acima s√£o verdadeiras e autorizo a realiza√ß√£o dos procedimentos.
                </p>
                <div class="print-sig-container" style="text-align: center; margin-top: 30px;">
                    <img id="printAssinaturaImg" src="" alt="Assinatura" style="height: 80px; display: block; margin: 0 auto;">
                    <div class="line" style="border-top: 1px solid #000; display: inline-block; width: 300px; margin-top: 5px;"></div>
                    <div class="label">Assinatura do Cliente</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agendamento -->
    <div id="modalAgendamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Agendamento</h2>
                <button class="modal-close" onclick="fecharModal('modalAgendamento')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="formAgendamento" class="modal-form">
                <input type="hidden" id="agendamentoId">
                
                <div class="form-group">
                    <label>TIPO DE AGENDAMENTO *</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="tipoAgendamento" value="servico" checked onclick="toggleTipoAgendamento()">
                                <span>Servi√ßo</span>
                            </label>

                            <label class="radio-label">
                                <input type="radio" name="tipoAgendamento" value="evento" onclick="toggleTipoAgendamento()">
                                <span>Evento Pessoal</span>
                            </label>
                        </div>
                </div>
                
                <div id="camposServico">
                    <div class="form-group">
                        <label for="agendamentoCliente">Cliente *</label>
                        <select id="agendamentoCliente" onchange="selectCliente()"></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoServico">Servi√ßo *</label>
                        <select id="agendamentoServico" onchange="selectServico()"></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoValor">Valor *</label>
                        <input type="text" id="agendamentoValor" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoStatusPagamento">Status Pagamento *</label>
                        <select id="agendamentoStatusPagamento">
                            <option value="pendente">Pendente</option>
                            <option value="pago">Pago</option>
                            <option value="devendo">Devendo</option>
                        </select>
                    </div>
                </div>
                
                <div id="camposEvento" style="display: none;">
                    <div class="form-group">
                        <label for="eventoNome">Nome do Evento *</label>
                        <input type="text" id="eventoNome" placeholder="Ex: Palestra de T√©cnicas Avan√ßadas">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="agendamentoData">Data *</label>
                        <input type="date" id="agendamentoData" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoHora">Hora *</label>
                        <input type="time" id="agendamentoHora" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="agendamentoObservacoes">Observa√ß√µes</label>
                    <textarea id="agendamentoObservacoes" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="fecharModal('modalAgendamento')">Cancelar</button>
                    <button type="submit" class="btn-primary">Agendar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Servi√ßo -->
    <div id="modalServico" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalServicoTitle">Novo Servi√ßo</h2>
                <button class="modal-close" onclick="fecharModal('modalServico')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="formServico" class="modal-form">
                <input type="hidden" id="servicoId">
                
                <div class="form-group">
                    <label for="servicoNome">Nome do Servi√ßo *</label>
                    <input type="text" id="servicoNome" required placeholder="Ex: Preenchimento Labial">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="servicoTipo">Tipo/Categoria *</label>
                        <input type="text" id="servicoTipo" required placeholder="Ex: Harmoniza√ß√£o Facial">
                    </div>
                    
                    <div class="form-group">
                        <label for="servicoDuracao">Dura√ß√£o (minutos) *</label>
                        <input type="number" id="servicoDuracao" required min="15" step="15" placeholder="60">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="servicoValor">Valor *</label>
                    <input type="number" id="servicoValor" required min="0" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label for="servicoDescricao">Descri√ß√£o</label>
                    <textarea id="servicoDescricao" rows="3" placeholder="Descri√ß√£o detalhada do servi√ßo..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="fecharModal('modalServico')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Estoque -->
    <div id="modalEstoque" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalEstoqueTitle">Novo Produto</h2>
                <button class="modal-close" onclick="fecharModal('modalEstoque')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="formEstoque" class="modal-form">
                <input type="hidden" id="estoqueId">
                
                <div class="form-group">
                    <label for="estoqueNome">Nome do Produto *</label>
                    <input type="text" id="estoqueNome" required placeholder="Ex: Botox 100U">
                </div>
                
                <div class="form-group">
                    <label for="estoqueDescricao">Descri√ß√£o</label>
                    <textarea id="estoqueDescricao" rows="2" placeholder="Descri√ß√£o do produto..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="estoqueValor">Valor Unit√°rio *</label>
                        <input type="number" id="estoqueValor" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="estoqueQuantidade">Quantidade *</label>
                        <input type="number" id="estoqueQuantidade" required min="0" placeholder="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="estoqueQuantidadeMinima">Quantidade M√≠nima *</label>
                    <input type="number" id="estoqueQuantidadeMinima" required min="1" placeholder="5">
                    <small>Voc√™ ser√° alertado quando o estoque estiver abaixo deste valor</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="fecharModal('modalEstoque')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modalHorarios" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Configurar Hor√°rios de Atendimento</h2>
                <button class="modal-close" onclick="fecharModal('modalHorarios')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">Defina os hor√°rios que aparecer√£o para os clientes.</p>
                <form id="formHorarios">
                    <div id="listaDiasSemana">
                        <div style="text-align: center; padding: 20px;">Carregando...</div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn-secondary" onclick="fecharModal('modalHorarios')">Cancelar</button>
                        <button type="submit" class="btn-primary">Salvar Configura√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="js/supabase-client.js?v=4.0"></script>
    <script src="js/app-agenda.js?v=5.0"></script>
    <script src="js/app-relatorios.js?v=4.0"></script>
    <script src="js/popular-dados.js?v=4.0"></script>
    <script src="js/app-anamnese.js?v=4.0"></script>
    <script src="js/app.js?v=123456"></script>

    <script>
        console.log("üö® SCRIPT PERFIL ATIVO");
        window.carregarDadosPerfil = async function() {
            /* ... (c√≥digo do perfil que j√° funcionava) ... */
            console.log("‚ö° Abrindo Perfil...");
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return alert("Fa√ßa login novamente.");
            
            document.getElementById('displayEmail').textContent = user.email;
            const link = `${window.location.origin}${window.location.pathname.replace('index.html', '')}agendar.html?ref=${user.id}`;
            if(document.getElementById('profLink')) document.getElementById('profLink').value = link;

            const { data: perfil } = await _supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
            if (perfil) {
                if(document.getElementById('profNome')) document.getElementById('profNome').value = perfil.nome || '';
                if(document.getElementById('profEspecialidade')) document.getElementById('profEspecialidade').value = perfil.especialidade || '';
                if(document.getElementById('profTelefone')) document.getElementById('profTelefone').value = perfil.telefone || '';
                if (perfil.foto_url && window.atualizarAvatarNaTela) window.atualizarAvatarNaTela(perfil.foto_url);
            }
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById('perfilPage').style.display = 'block';
        };

        window.salvarPerfilReal = async function(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            const txt = btn.textContent;
            btn.textContent = "Salvando...";
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                const dados = {
                    id: user.id,
                    nome: document.getElementById('profNome').value,
                    especialidade: document.getElementById('profEspecialidade').value,
                    telefone: document.getElementById('profTelefone').value
                };
                const { error } = await _supabase.from('profiles').upsert(dados);
                if (error) throw error;
                alert("Salvo com sucesso!");
            } catch (e) { alert("Erro: " + e.message); }
            finally { btn.textContent = txt; }
        };
    </script>

    <script>
        console.log("üö® SCRIPT GOOGLE SYNC V3 (AUTO-REPAIR) üö®");

        // --- CONFIGURA√á√ÉO (PREENCHA AQUI!) ---
        const GOOGLE_API_KEY = 'AIzaSyDnpUtzu2QnkWSPvl2c'; // <--- ‚ö†Ô∏è COLE SUA CHAVE AIza... AQUI
        const GOOGLE_CLIENT_ID = '202923629512-v63i5nl8et7rrmhhbah3brdqr510lgp4.apps.googleusercontent.com';

        window.sincronizarPendentesGoogle = async function() {
            console.log("üñ±Ô∏è Sincronizar Clicado. Verificando motor...");
            
            const btn = document.querySelector('button[onclick*="sincronizarPendentesGoogle"]');
            const originalIcon = btn ? btn.innerHTML : '';
            if(btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; }

            try {
                // 1. AUTO-CORRE√á√ÉO: Se o gapi existe mas n√£o iniciou, inicia agora
                if (typeof gapi !== 'undefined' && (!gapi.client || !gapi.client.calendar)) {
                    console.log("‚ö†Ô∏è GAPI n√£o iniciado. Iniciando manualmente agora...");
                    
                    await new Promise((resolve, reject) => {
                        gapi.load('client:auth2', resolve);
                    });

                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        clientId: GOOGLE_CLIENT_ID,
                        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
                        scope: "https://www.googleapis.com/auth/calendar.events"
                    });
                    console.log("‚úÖ GAPI Iniciado via Script de Emerg√™ncia!");
                }

                // 2. Verifica Conex√£o
                if (typeof gapi === 'undefined' || !gapi.auth2) {
                    throw new Error("Erro Cr√≠tico: A biblioteca do Google n√£o carregou. Verifique sua internet.");
                }

                const auth = gapi.auth2.getAuthInstance();
                if (!auth.isSignedIn.get()) {
                    // Tenta logar na hora se n√£o estiver logado
                    await auth.signIn();
                }

                // 3. Busca Pendentes
                const hoje = new Date().toISOString().split('T')[0];
                const { data: pendentes } = await _supabase
                    .from('agendamentos')
                    .select('*, clientes(nome)')
                    .gte('data', hoje)
                    .is('google_event_id', null);

                if (!pendentes || pendentes.length === 0) {
                    alert("‚úÖ Tudo sincronizado! Nada novo para enviar.");
                } else {
                    let enviados = 0;
                    for (const agenda of pendentes) {
                        try {
                            const inicio = `${agenda.data}T${agenda.hora}:00`;
                            const fim = new Date(new Date(inicio).getTime() + 60*60*1000).toISOString().split('.')[0];
                            
                            const evento = {
                                'summary': `üíÜ‚Äç‚ôÄÔ∏è ${agenda.servico} - ${agenda.clientes?.nome || 'Site'}`,
                                'description': `Obs: ${agenda.observacoes || '-'}`,
                                'start': { 'dateTime': inicio, 'timeZone': 'America/Sao_Paulo' },
                                'end':   { 'dateTime': fim, 'timeZone': 'America/Sao_Paulo' }
                            };

                            const res = await gapi.client.calendar.events.insert({
                                'calendarId': 'primary',
                                'resource': evento
                            });

                            if (res.result.id) {
                                await _supabase.from('agendamentos').update({ google_event_id: res.result.id }).eq('id', agenda.id);
                                enviados++;
                            }
                        } catch (err) { console.error(err); }
                    }
                    alert(`üéâ Sucesso! ${enviados} agendamentos enviados.`);
                }

            } catch (erro) {
                console.error(erro);
                alert("Erro: " + erro.message + "\n(Verifique se colou a API KEY no script)");
            } finally {
                if(btn) { btn.innerHTML = originalIcon; btn.disabled = false; }
            }
        };
    </script>
    
</body>
</html>
